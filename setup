#!/usr/bin/env python

import sys
import re
import os
import platform
import shutil

files = [ "gitconfig", "vim", "vimrc", "myconfigs", "bashrc" ]
mac_linux_only_files = [ "inputrc", "zshrc", "tmux.conf" ]
cygwin_only_files = [ "cygwin" ]
mingw_files = [ "mingw", "profile" ]

if platform.system() == "Windows":
  dir_delim = "\\"
else:
  dir_delim = "/"

def print_usage():
  global dir_delim
  print "Usage:"
  print "help\t\tPrint usage"
  print "install\t\tInstall dotfiles to ~" + dir_delim + ".<file>"
  print "uninstall\tUninstall dotfiles from ~" + dir_delim + ".<file>"

def get_platform_files():
  global files, mac_linux_only_files
  if re.search(r"(linux|darwin)", sys.platform):
    print "Running on on linux or Mac."
    files.extend(mac_linux_only_files)
  if re.search(r"cygwin", sys.platform):
    print "Running on cygwin"
    files.extend(cygwin_only_files)
  if re.search(r"win", sys.platform):
    print "Running on mingw"
    files.extend(mingw_files)
  return files

def install():
  files_to_install = get_platform_files()

  os.chdir(os.path.abspath(os.path.dirname(__file__)))

  for file in files_to_install:
    if platform.system() == "Windows":
      fullpath = os.path.expanduser("~") + "\." + file
    else:
      fullpath = os.path.expanduser("~") + dir_delim + "." + file

    if os.path.exists(fullpath) or os.path.islink(fullpath):
      print "Removing %s... " % fullpath
      try:
        os.remove(fullpath)
      except(OSError):
        shutil.rmtree(fullpath)
    else:
      print "File %s not found..." % fullpath

    source = os.path.realpath(os.path.dirname(__file__)) + dir_delim + file
    dest = (os.path.expanduser("~") + dir_delim + "." + file)
    print "copying " + source + " to " + dest

    if os.path.isdir(source):
      os.makedirs(dest)
      for filename in os.listdir(source):
        if os.path.isdir(source + dir_delim + filename):
          shutil.copytree(source + dir_delim + filename, \
                          dest + dir_delim + filename)
        else:
          shutil.copy2(source + dir_delim + filename, \
                       dest + dir_delim + filename)
    else:
      shutil.copy2(source, dest)


def uninstall():
  files_to_uninstall = get_platform_files()
  homedir = os.path.expanduser("~") + dir_delim
  for file in files_to_uninstall:
    fullpath = os.path.expanduser("~") + dir_delim + "." + file
    if os.path.exists(fullpath) or os.path.islink(fullpath):
      print "Removing " + fullpath + "..."
      try:
        os.unlink(fullpath)
      except:
        shutil.rmtree(fullpath)
    else:
      print "File %s not found..." % fullpath
  for afile in os.listdir(homedir):
    if afile.startswith("."):
      ans = raw_input("Would you like to remove this dot file: " + afile + " (Y/q)? ")
      if ans == "Y":
        print "Removing", afile
        if os.path.isdir(homedir + afile):
          shutil.rmtree(homedir + afile)
        else:
          os.unlink(homedir + afile)
      elif ans == "q":
        return

if __name__ == "__main__":
  if len(sys.argv) != 2:
    print "setup takes one argument"
    print_usage()
    sys.exit()

  if sys.argv[1] == "install":
    install()
  elif sys.argv[1] == "uninstall":
    uninstall()
  elif sys.argv[1] == "help":
    print_usage()
  else:
    print "Command not valid"
    print_usage()
